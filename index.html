<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mobile AL</title>
  <link rel="manifest" href="/manifest.webmanifest">
  <meta name="theme-color" content="#0b0f17">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    :root{
      --bg:#0b0f17; --panel:rgba(255,255,255,.06); --border:rgba(255,255,255,.10);
      --text:rgba(255,255,255,.92); --muted:rgba(255,255,255,.62); --muted2:rgba(255,255,255,.45);
      --accent:#7c5cff; --shadow:0 12px 30px rgba(0,0,0,.35); --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background:
        radial-gradient(1200px 600px at 20% -10%, rgba(124,92,255,.25), transparent 60%),
        radial-gradient(900px 500px at 110% 10%, rgba(46,229,157,.18), transparent 55%),
        var(--bg);
      color:var(--text);
      font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    }
    .top-bar{
      position:fixed; top:0; left:0; right:0; height:70px; padding:12px 14px;
      display:flex; align-items:center; justify-content:space-between; z-index:10;
      backdrop-filter:blur(10px); background:rgba(11,15,23,.72);
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    .user-pill{
      display:flex; align-items:center; gap:10px; padding:10px 12px; border-radius:999px;
      background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.08); max-width:65%;
    }
    .avatar{
      width:34px; height:34px; border-radius:999px; display:flex; align-items:center; justify-content:center;
      background:linear-gradient(135deg, rgba(124,92,255,.9), rgba(46,229,157,.85));
      color:#0b0f17; font-weight:900; box-shadow:0 10px 24px rgba(0,0,0,.35); flex:0 0 auto;
    }
    .user-meta{line-height:1.15; min-width:0}
    .user-name{font-size:13px; font-weight:800; overflow:hidden; text-overflow:ellipsis; white-space:nowrap}
    .user-sub{font-size:11px; color:var(--muted); margin-top:2px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap}
    .brand{font-weight:900; letter-spacing:.6px; display:flex; align-items:center; gap:10px}
    .brand-badge{width:10px; height:10px; border-radius:999px; background:var(--accent); box-shadow:0 0 0 6px rgba(124,92,255,.15)}
    .brand-title{font-size:15px}
    .content{padding:14px; padding-top:86px; padding-bottom:92px; max-width:820px; margin:0 auto}
    .screen{display:none} .screen.active{display:block}
    .page-title{margin:8px 0 4px; font-size:22px; font-weight:900}
    .page-subtitle{margin:0 0 14px; font-size:13px; color:var(--muted)}
    .card{background:var(--panel); border:1px solid var(--border); border-radius:var(--radius); padding:14px; box-shadow:var(--shadow)}
    .card+.card{margin-top:12px}
    .row{display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:10px; flex-wrap:wrap}
    .badge{padding:6px 10px; border-radius:999px; font-size:12px; font-weight:800;
      background:rgba(124,92,255,.18); border:1px solid rgba(124,92,255,.35); overflow:hidden; text-overflow:ellipsis; white-space:nowrap}
    .btn{padding:10px 12px; border-radius:12px; border:1px solid rgba(255,255,255,.12); background:rgba(255,255,255,.05);
      color:var(--text); cursor:pointer; font-weight:900}
    .btn:active{transform:scale(.99)}
    .chip-grid{display:grid; grid-template-columns:repeat(4,minmax(0,1fr)); gap:10px}
    .chip{padding:10px; border-radius:999px; border:1px solid rgba(255,255,255,.10); background:rgba(255,255,255,.04);
      font-size:12px; font-weight:850; display:flex; justify-content:center; align-items:center; cursor:pointer; user-select:none}
    .chip.active{background:linear-gradient(135deg, rgba(124,92,255,.35), rgba(46,229,157,.22)); border:1px solid rgba(124,92,255,.55)}
    .result{
      background:rgba(0,0,0,.22); border:1px solid rgba(255,255,255,.08); border-radius:16px; padding:12px;
      min-height:150px; white-space:pre-wrap; font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Courier New",monospace;
      font-size:12px; line-height:1.45; color:rgba(255,255,255,.86)
    }
    .hint{color:var(--muted2); font-size:12px; margin-top:10px}
    .input{
      width:100%; padding:12px 14px; border-radius:14px; border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.05); color:var(--text); outline:none; font-weight:900
    }
    .bottom-bar{
      position:fixed; bottom:0; left:0; right:0; height:76px;
      padding:10px 12px calc(10px + env(safe-area-inset-bottom));
      display:flex; justify-content:space-around; align-items:flex-end; z-index:10;
      backdrop-filter:blur(10px); background:rgba(11,15,23,.72); border-top:1px solid rgba(255,255,255,.08);
    }
    .tab{width:25%; text-align:center; cursor:pointer; user-select:none; padding:8px; border-radius:16px}
    .tab .icon{display:block; font-size:16px; margin-bottom:6px; color:rgba(255,255,255,.70)}
    .tab .label{font-size:12px; font-weight:900; color:rgba(255,255,255,.72)}
    .tab.active{background:rgba(124,92,255,.14); border:1px solid rgba(124,92,255,.28)}
    .tab.active .icon,.tab.active .label{color:rgba(255,255,255,.92)}
    .chat-box{display:flex; gap:10px; align-items:center}
    .chat-log{min-height:220px}
    @media (max-width:380px){.chip-grid{grid-template-columns:repeat(3,minmax(0,1fr))}}
  </style>
</head>
<body>
  <div class="top-bar">
    <div class="user-pill">
      <div class="avatar" id="avatar">?</div>
      <div class="user-meta">
        <div class="user-name" id="userName">Niet ingelogd</div>
        <div class="user-sub" id="userSub">PWA / Browser</div>
      </div>
    </div>
    <div class="brand">
      <div class="brand-badge"></div>
      <div class="brand-title">Mobile AL</div>
    </div>
  </div>

  <div class="content">

    <div id="screen-login" class="screen active">
      <div class="page-title">Inloggen</div>
      <div class="page-subtitle">Vul je pincode in.</div>
      <div class="card">
        <div class="row" style="margin-bottom:0">
          <input id="pinInput" class="input" inputmode="numeric" maxlength="8" placeholder="PIN (bv. 3214)" />
          <button class="btn" style="min-width:120px" onclick="doLogin()">Login</button>
        </div>
        <div class="hint" id="loginHint">Nog niet ingelogd.</div>
      </div>
    </div>

    <div id="screen-trip" class="screen">
      <div class="page-title">Trip Analyse</div>
      <div class="page-subtitle">Selecteer NP41‚ÄìNP68 of ‚ÄúTotaal‚Äù.</div>

      <div class="card">
        <div class="row">
          <div class="badge" id="selectedBadge">Geen selectie</div>
          <button class="btn" onclick="refreshSelected()">Refresh</button>
        </div>
        <div class="chip-grid" id="tripChips"></div>
        <div class="hint">Live data uit Analyse tab.</div>
      </div>

      <div class="card">
        <div class="result" id="analysisResult">Selecteer een trip‚Ä¶</div>
      </div>
    </div>

    <div id="screen-export" class="screen">
      <div class="page-title">Export Data</div>
      <div class="page-subtitle">Laatste export-rijen.</div>
      <div class="card">
        <div class="row">
          <div class="badge">Laatste 50</div>
          <button class="btn" onclick="loadExport()">Refresh</button>
        </div>
        <div class="result" id="exportResult">Nog niets geladen.</div>
      </div>
    </div>

    <div id="screen-planning" class="screen">
      <div class="page-title">Planning</div>
      <div class="page-subtitle">Laatste planning-rijen.</div>
      <div class="card">
        <div class="row">
          <div class="badge">Laatste 50</div>
          <button class="btn" onclick="loadPlanning()">Refresh</button>
        </div>
        <div class="result" id="planningResult">Nog niets geladen.</div>
      </div>
    </div>

    <div id="screen-chat" class="screen">
      <div class="page-title">Chatbot</div>
      <div class="page-subtitle">Vraag bv: ‚Äúwat deed NP41 op 22/12/2024 tussen 23u en 24u‚Äù.</div>
      <div class="card">
        <div class="result chat-log" id="chatLog">Stel je vraag‚Ä¶</div>
        <div class="hint">De bot zoekt eerst in Export tab en vat samen.</div>
      </div>
      <div class="card">
        <div class="chat-box">
          <input id="chatInput" class="input" placeholder="Typ je vraag‚Ä¶" />
          <button class="btn" style="min-width:120px" onclick="sendChat()">Send</button>
        </div>
      </div>
    </div>

  </div>

  <div class="bottom-bar" id="bottomBar">
    <div class="tab active" onclick="nav('screen-trip', this)"><span class="icon">‚ñ¶</span><span class="label">Trip</span></div>
    <div class="tab" onclick="nav('screen-export', this)"><span class="icon">‚á™</span><span class="label">Export</span></div>
    <div class="tab" onclick="nav('screen-planning', this)"><span class="icon">üóì</span><span class="label">Planning</span></div>
    <div class="tab" onclick="nav('screen-chat', this)"><span class="icon">üí¨</span><span class="label">Chat</span></div>
  </div>

<script>
  const tg = (window.Telegram && window.Telegram.WebApp) ? window.Telegram.WebApp : null;
  if (tg) tg.expand();

  if ("serviceWorker" in navigator) navigator.serviceWorker.register("/service-worker.js");

  const TOKEN_KEY = "mobile_al_token";
  const bottomBar = document.getElementById("bottomBar");

  function setHeader(name, sub){
    document.getElementById("userName").innerText = name || "Niet ingelogd";
    document.getElementById("userSub").innerText = sub || "PWA / Browser";
    document.getElementById("avatar").innerText = name ? name.trim()[0].toUpperCase() : "?";
  }

  function showOnly(id){
    document.querySelectorAll(".screen").forEach(s=>s.classList.remove("active"));
    document.getElementById(id).classList.add("active");
  }

  function nav(id, el){
    document.querySelectorAll(".screen").forEach(s=>s.classList.remove("active"));
    document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
    document.getElementById(id).classList.add("active");
    el.classList.add("active");
  }

  async function boot(){
    bottomBar.style.display = "none";
    setHeader("Niet ingelogd","PWA / Browser");
    const token = localStorage.getItem(TOKEN_KEY);
    if (!token){ showOnly("screen-login"); return; }

    const me = await fetch(`/api/me?token=${encodeURIComponent(token)}`).then(r=>r.json()).catch(()=>null);
    if (!me || !me.ok){
      localStorage.removeItem(TOKEN_KEY);
      showOnly("screen-login");
      return;
    }

    setHeader(me.user.name, me.user.role);
    bottomBar.style.display = "flex";
    showOnly("screen-trip");
  }
  boot();

  async function doLogin(){
    const pin = document.getElementById("pinInput").value.trim();
    const hint = document.getElementById("loginHint");
    if (!pin){ hint.innerText="Vul een PIN in."; return; }
    hint.innerText="Inloggen‚Ä¶";

    const data = await fetch("/api/login", {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ pin })
    }).then(r=>r.json()).catch(e=>({ok:false,error:String(e)}));

    if (!data.ok){ hint.innerText = data.error || "Login mislukt"; return; }

    localStorage.setItem(TOKEN_KEY, data.token);
    setHeader(data.user.name, data.user.role);
    bottomBar.style.display="flex";
    showOnly("screen-trip");
    hint.innerText="Ingelogd ‚úÖ";
  }

  // ===== Trip chips =====
  const trips = []; for (let i=41;i<=68;i++) trips.push(`NP${i}`); trips.push("Totaal");
  const chipsEl = document.getElementById("tripChips");
  const badgeEl = document.getElementById("selectedBadge");
  const resultEl = document.getElementById("analysisResult");
  let selectedTrip = null;

  trips.forEach(t=>{
    const chip=document.createElement("div");
    chip.className="chip"; chip.innerText=t;
    chip.onclick=()=>selectTrip(t,chip);
    chipsEl.appendChild(chip);
  });

  function selectTrip(trip, chipEl){
    selectedTrip = trip;
    document.querySelectorAll(".chip").forEach(c=>c.classList.remove("active"));
    chipEl.classList.add("active");
    badgeEl.innerText = `Geselecteerd: ${trip}`;
    loadTrip(trip);
  }

  async function refreshSelected(){
    if (!selectedTrip){ resultEl.innerText="Selecteer eerst een trip‚Ä¶"; return; }
    loadTrip(selectedTrip);
  }

  async function loadTrip(trip){
    const token = localStorage.getItem(TOKEN_KEY);
    resultEl.innerText = `Laden‚Ä¶ (${trip})`;
    const data = await fetch(`/api/trip?token=${encodeURIComponent(token)}&trip=${encodeURIComponent(trip)}`).then(r=>r.json()).catch(e=>({ok:false,error:String(e)}));
    if (!data.ok){ resultEl.innerText = "Error: " + (data.error||"Onbekend"); return; }
    resultEl.innerText = data.analysisText || "(geen tekst)";
  }

  // ===== Export =====
  async function loadExport(){
    const token = localStorage.getItem(TOKEN_KEY);
    const el = document.getElementById("exportResult");
    el.innerText="Laden‚Ä¶";
    const data = await fetch(`/api/export?token=${encodeURIComponent(token)}`).then(r=>r.json()).catch(e=>({ok:false,error:String(e)}));
    if (!data.ok){ el.innerText="Error: "+(data.error||"Onbekend"); return; }
    el.innerText = JSON.stringify(data.rows, null, 2);
  }

  // ===== Planning =====
  async function loadPlanning(){
    const token = localStorage.getItem(TOKEN_KEY);
    const el = document.getElementById("planningResult");
    el.innerText="Laden‚Ä¶";
    const data = await fetch(`/api/planning?token=${encodeURIComponent(token)}`).then(r=>r.json()).catch(e=>({ok:false,error:String(e)}));
    if (!data.ok){ el.innerText="Error: "+(data.error||"Onbekend"); return; }
    el.innerText = JSON.stringify(data.rows, null, 2);
  }

  // ===== Chat =====
  function appendChat(role, text){
    const log = document.getElementById("chatLog");
    const prefix = role === "you" ? "Jij: " : "Bot: ";
    log.innerText += `\n\n${prefix}${text}`;
    log.scrollTop = log.scrollHeight;
  }

  async function sendChat(){
    const token = localStorage.getItem(TOKEN_KEY);
    const inp = document.getElementById("chatInput");
    const msg = inp.value.trim();
    if (!msg) return;
    inp.value="";
    appendChat("you", msg);

    const data = await fetch("/api/chat", {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ token, message: msg })
    }).then(r=>r.json()).catch(e=>({ok:false,error:String(e)}));

    if (!data.ok){
      appendChat("bot", "Error: " + (data.error||"Onbekend"));
      return;
    }
    appendChat("bot", data.answer || "Geen antwoord");
  }
</script>
</body>
</html>